!function(n){"use strict";const e={init:function(){this.bindEvents(),this.initTabs(),this.initToggles(),this.initColorPickers(),this.initApiTest(),this.initChart(),this.initGdprTools(),this.initImportExport()},bindEvents:function(){n(".ofac-settings-form").on("submit",this.handleFormSubmit.bind(this)),n("[data-confirm]").on("click",this.handleConfirm.bind(this)),n("[data-toggle-target]").on("change",this.handleToggleTarget.bind(this)),n(".ofac-media-upload").on("click",this.handleMediaUpload.bind(this)),n(".ofac-media-remove").on("click",this.handleMediaRemove.bind(this))},initTabs:function(){const e=n(".ofac-tabs");if(!e.length)return;e.on("click",".ofac-tab",function(o){o.preventDefault();const t=n(this),i=t.data("tab");e.find(".ofac-tab").removeClass("ofac-tab--active"),t.addClass("ofac-tab--active"),n(".ofac-tab-content").removeClass("ofac-tab-content--active"),n(`#${i}`).addClass("ofac-tab-content--active"),history.pushState&&history.pushState(null,null,`#${i}`)});const o=window.location.hash.slice(1);o&&n(`.ofac-tab[data-tab="${o}"]`).trigger("click")},initToggles:function(){n(".ofac-toggle__input").each(function(){const e=n(this),o=e.data("toggle-target");if(o){const t=n(o);t.toggle(e.is(":checked")),e.on("change",function(){t.slideToggle(200)})}})},initColorPickers:function(){n(".ofac-color-picker__input").each(function(){const e=n(this),o=e.siblings(".ofac-color-picker__value");e.on("input",function(){o.text(e.val())})}),n.fn.wpColorPicker&&n(".ofac-wp-color-picker").wpColorPicker()},initApiTest:function(){const e=n("#ofac-test-connection"),o=n("#ofac-connection-result");e.length&&e.on("click",function(t){t.preventDefault();const i=n("#ofac_api_url").val()||"",a=n("#ofac_api_key").val()||"",c=n("#ofac_workspace_slug").val()||"";if(!i.trim())return o.html("<span class=\"ofac-result-error\">⚠️ Veuillez saisir l'URL de l'API</span>"),void n("#ofac_api_url").focus();if(!a.trim())return o.html('<span class="ofac-result-error">⚠️ Veuillez saisir la clé API</span>'),void n("#ofac_api_key").focus();if(!c.trim())return o.html('<span class="ofac-result-error">⚠️ Veuillez saisir le slug du workspace</span>'),void n("#ofac_workspace_slug").focus();const s=e.text();e.prop("disabled",!0).html('<span class="ofac-spinner"></span> Test en cours...'),o.html('<span class="ofac-result-loading"><span class="ofac-spinner"></span> Connexion à AnythingLLM...</span>'),n.ajax({url:ofacAdmin.ajaxUrl,type:"POST",data:{action:"ofac_test_connection",nonce:ofacAdmin.nonce,api_url:i,api_key:a,workspace_slug:c,save_on_success:"true"},success:function(n){if(n.success){let t=n.data.message,i="✓",a="ofac-result-success";n.data.saved&&(i="✓✓"),o.html('<span class="'+a+'">'+i+" "+t+"</span>"),e.html("✓ Connecté !").addClass("ofac-btn-success"),setTimeout(function(){e.removeClass("ofac-btn-success").text(s)},3e3)}else{const t=n.data.message||n.data||"Erreur inconnue";o.html('<span class="ofac-result-error">✗ '+t+"</span>"),e.text(s)}},error:function(n,t,i){let a="Erreur de connexion";0===n.status?a="Impossible de contacter le serveur":403===n.status?a="Accès refusé":500===n.status?a="Erreur serveur":i&&(a=i),o.html('<span class="ofac-result-error">✗ '+a+"</span>"),e.text(s)},complete:function(){e.prop("disabled",!1)}})})},initChart:function(){const e=n("#ofac-stats-chart");if(!e.length||"undefined"==typeof Chart)return;const o=e[0].getContext("2d"),t=e.data("chart");t&&new Chart(o,{type:"line",data:{labels:t.labels,datasets:[{label:ofacAdminConfig.i18n.conversations,data:t.conversations,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.4},{label:ofacAdminConfig.i18n.messages,data:t.messages,borderColor:"#22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}}}})},initGdprTools:function(){n("#ofac-export-user-data").on("submit",function(o){o.preventDefault();const t=n(this),i=t.find("button"),a=t.find('input[name="user_identifier"]').val().trim();a?(i.prop("disabled",!0),n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_export_user_data",nonce:ofacAdminConfig.nonce,identifier:a},success:function(n){if(n.success){const o=new Blob([JSON.stringify(n.data,null,2)],{type:"application/json"}),t=URL.createObjectURL(o),i=document.createElement("a");i.href=t,i.download=`user-data-${a}-${Date.now()}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(t),e.showNotice("success",ofacAdminConfig.i18n.data_exported)}else e.showNotice("error",n.data.message||ofacAdminConfig.i18n.export_error)},error:function(){e.showNotice("error",ofacAdminConfig.i18n.export_error)},complete:function(){i.prop("disabled",!1)}})):e.showNotice("error",ofacAdminConfig.i18n.enter_identifier)}),n("#ofac-delete-user-data").on("submit",function(o){o.preventDefault();const t=n(this),i=t.find("button"),a=t.find('input[name="user_identifier"]'),c=a.val().trim();c?confirm(ofacAdminConfig.i18n.confirm_delete_data)&&(i.prop("disabled",!0),n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_delete_user_data",nonce:ofacAdminConfig.nonce,identifier:c},success:function(n){n.success?(e.showNotice("success",n.data.message),a.val("")):e.showNotice("error",n.data.message||ofacAdminConfig.i18n.delete_error)},error:function(){e.showNotice("error",ofacAdminConfig.i18n.delete_error)},complete:function(){i.prop("disabled",!1)}})):e.showNotice("error",ofacAdminConfig.i18n.enter_identifier)}),n("#ofac-cleanup-expired").on("click",function(o){o.preventDefault();const t=n(this);confirm(ofacAdminConfig.i18n.confirm_cleanup)&&(t.prop("disabled",!0),n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_cleanup_expired",nonce:ofacAdminConfig.nonce},success:function(n){n.success?e.showNotice("success",n.data.message):e.showNotice("error",n.data.message||ofacAdminConfig.i18n.cleanup_error)},error:function(){e.showNotice("error",ofacAdminConfig.i18n.cleanup_error)},complete:function(){t.prop("disabled",!1)}}))})},initImportExport:function(){n("#ofac-export-settings").on("click",function(e){e.preventDefault(),n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_export_settings",nonce:ofacAdminConfig.nonce},success:function(n){if(n.success){const e=new Blob([JSON.stringify(n.data,null,2)],{type:"application/json"}),o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download=`ofac-settings-${Date.now()}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(o)}}})}),n("#ofac-import-settings").on("change",function(o){const t=o.target.files[0];if(!t)return;const i=new FileReader;i.onload=function(o){try{const t=JSON.parse(o.target.result);if(!confirm(ofacAdminConfig.i18n.confirm_import))return;n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_import_settings",nonce:ofacAdminConfig.nonce,settings:JSON.stringify(t)},success:function(n){n.success?(e.showNotice("success",ofacAdminConfig.i18n.settings_imported),setTimeout(()=>location.reload(),1500)):e.showNotice("error",n.data.message)}})}catch(n){e.showNotice("error",ofacAdminConfig.i18n.invalid_file)}},i.readAsText(t)})},handleFormSubmit:function(e){n(e.currentTarget).find('[type="submit"]').prop("disabled",!0).html('<span class="ofac-spinner"></span> '+ofacAdminConfig.i18n.saving)},handleConfirm:function(e){const o=n(e.currentTarget).data("confirm");confirm(o)||e.preventDefault()},handleToggleTarget:function(e){const o=n(e.currentTarget),t=o.data("toggle-target"),i=n(t);if(o.is(":checkbox"))i.slideToggle(200);else{const n=o.val(),e=o.data("toggle-values");e&&i.toggle(e.includes(n))}},handleMediaUpload:function(e){e.preventDefault();const o=n(e.currentTarget).closest(".ofac-media-field"),t=o.find('input[type="hidden"]'),i=o.find(".ofac-media-preview"),a=o.find(".ofac-media-remove"),c=wp.media({title:ofacAdmin.strings.selectImage||"Sélectionner une image",button:{text:ofacAdmin.strings.useImage||"Utiliser cette image"},multiple:!1,library:{type:"image"}});c.on("select",function(){const n=c.state().get("selection").first().toJSON();t.val(n.id),i.html('<img src="'+n.url+'" style="max-width:150px;max-height:150px;">'),a.show()}),c.open()},handleMediaRemove:function(e){e.preventDefault();const o=n(e.currentTarget),t=o.closest(".ofac-media-field"),i=t.find('input[type="hidden"]'),a=t.find(".ofac-media-preview");i.val(""),a.empty(),o.hide()},showNotice:function(e,o){const t=n(`\n                <div class="ofac-alert ofac-alert--${e}">\n                    ${o}\n                    <button type="button" class="ofac-alert__dismiss">&times;</button>\n                </div>\n            `);n(".ofac-admin-header").after(t),t.find(".ofac-alert__dismiss").on("click",function(){t.fadeOut(200,function(){t.remove()})}),setTimeout(function(){t.fadeOut(200,function(){t.remove()})},5e3)}},o={init:function(){this.bindEvents()},bindEvents:function(){n(".ofac-view-conversation").on("click",this.viewConversation.bind(this)),n(".ofac-delete-conversation").on("click",this.deleteConversation.bind(this)),n("#ofac-logs-bulk-action").on("click",this.bulkAction.bind(this)),n("#ofac-select-all").on("change",this.selectAll.bind(this)),n(".ofac-logs-filter").on("change",this.applyFilters.bind(this))},viewConversation:function(e){e.preventDefault();const t=n(e.currentTarget).data("id");n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_get_conversation",nonce:ofacAdminConfig.nonce,conversation_id:t},success:function(n){n.success&&o.showConversationModal(n.data)}})},showConversationModal:function(e){const o=e.messages.map(function(n){return`\n                    <div class="ofac-modal-message ofac-modal-message--${n.role}">\n                        <div class="ofac-modal-message__role">${n.role}</div>\n                        <div class="ofac-modal-message__content">${n.content}</div>\n                        <div class="ofac-modal-message__time">${n.created_at}</div>\n                    </div>\n                `}).join(""),t=`\n                <div class="ofac-modal-overlay" id="ofac-conversation-modal">\n                    <div class="ofac-modal-dialog">\n                        <div class="ofac-modal-header">\n                            <h3>Conversation #${e.id}</h3>\n                            <button type="button" class="ofac-modal-close">&times;</button>\n                        </div>\n                        <div class="ofac-modal-body">\n                            <div class="ofac-modal-meta">\n                                <span>Session: ${e.session_id}</span>\n                                <span>Date: ${e.started_at}</span>\n                            </div>\n                            <div class="ofac-modal-messages">\n                                ${o}\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;n("body").append(t),n("#ofac-conversation-modal").on("click",function(e){n(e.target).is(".ofac-modal-overlay, .ofac-modal-close")&&n(this).remove()})},deleteConversation:function(e){if(e.preventDefault(),!confirm(ofacAdminConfig.i18n.confirm_delete_conversation))return;const o=n(e.currentTarget),t=o.closest("tr"),i=o.data("id");n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_delete_conversation",nonce:ofacAdminConfig.nonce,conversation_id:i},success:function(n){n.success&&t.fadeOut(200,function(){t.remove()})}})},bulkAction:function(e){e.preventDefault();const o=n("#ofac-bulk-action-select").val(),t=[];n(".ofac-log-checkbox:checked").each(function(){t.push(n(this).val())}),o&&t.length&&("delete"!==o||confirm(ofacAdminConfig.i18n.confirm_bulk_delete))&&n.ajax({url:ofacAdminConfig.ajax_url,type:"POST",data:{action:"ofac_bulk_action",nonce:ofacAdminConfig.nonce,bulk_action:o,ids:t},success:function(n){n.success&&location.reload()}})},selectAll:function(e){const o=n(e.currentTarget).is(":checked");n(".ofac-log-checkbox").prop("checked",o)},applyFilters:function(){const e=new URLSearchParams(window.location.search);n(".ofac-logs-filter").each(function(){const o=n(this),t=o.attr("name"),i=o.val();i?e.set(t,i):e.delete(t)}),window.location.search=e.toString()}};n(document).ready(function(){e.init(),o.init()})}(jQuery);
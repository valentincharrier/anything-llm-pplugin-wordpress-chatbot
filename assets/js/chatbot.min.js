!function(){"use strict";if("undefined"!=typeof ofacConfig){window.OFACChatbot=new class{constructor(){this.config=ofacConfig,this.isOpen=!1,this.isTyping=!1,this.conversationHistory=[],this.sessionId=this.getOrCreateSessionId(),this.hasConsent=!1,this.focusTrap=null,this.lastFocusedElement=null,this.abortController=null,this.messageQueue=[],this.isProcessing=!1,this.commandHistory=[],this.commandHistoryIndex=-1,this.currentInput="",this.pendingImage=null,this.elements={},this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOutsideClick=this.handleOutsideClick.bind(this),this.handleResize=this.debounce(this.handleResize.bind(this),250),this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.setup()):this.setup()}setup(){this.cacheElements(),this.elements.container?(this.loadHistory(),this.loadCommandHistory(),this.checkConsent(),this.bindEvents(),this.checkReducedMotion(),this.trigger("ofac:init",{chatbot:this})):console.error("OFAC: Chatbot container not found")}cacheElements(){this.elements={container:document.getElementById("ofac-chatbot"),trigger:document.getElementById("ofac-trigger"),modal:document.getElementById("ofac-modal"),closeBtn:document.getElementById("ofac-close"),messagesContainer:document.getElementById("ofac-messages"),inputForm:document.getElementById("ofac-input-form"),inputField:document.getElementById("ofac-input"),sendBtn:document.getElementById("ofac-send"),fileInput:document.getElementById("ofac-file-input"),fileBtn:document.getElementById("ofac-file-btn"),typingIndicator:document.getElementById("ofac-typing"),consentDialog:document.getElementById("ofac-consent-screen"),consentAccept:document.getElementById("ofac-consent-accept"),consentDecline:document.getElementById("ofac-consent-decline"),quickReplies:document.getElementById("ofac-quick-replies"),exportBtn:document.getElementById("ofac-export"),resetBtn:document.getElementById("ofac-reset")}}bindEvents(){this.elements.trigger&&this.elements.trigger.addEventListener("click",()=>this.open()),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",()=>this.close()),this.elements.inputForm&&this.elements.inputForm.addEventListener("submit",e=>{e.preventDefault(),this.sendMessage()}),this.elements.inputField&&(this.elements.inputField.addEventListener("input",()=>{this.autoResizeInput(),this.updateSendButton(),this.commandHistoryIndex=-1}),this.elements.inputField.addEventListener("keydown",e=>{if("Enter"===e.key&&!e.shiftKey)return e.preventDefault(),void this.sendMessage();"ArrowUp"!==e.key&&"ArrowDown"!==e.key||(this.navigateHistory("ArrowUp"===e.key?"up":"down"),e.preventDefault())})),this.elements.fileBtn&&this.elements.fileInput&&(this.elements.fileBtn.addEventListener("click",()=>{this.elements.fileInput.click()}),this.elements.fileInput.addEventListener("change",e=>{this.handleFileUpload(e.target.files)})),this.elements.consentAccept&&this.elements.consentAccept.addEventListener("click",()=>{this.acceptConsent()}),this.elements.consentDecline&&this.elements.consentDecline.addEventListener("click",()=>{this.declineConsent()}),this.elements.exportBtn&&this.elements.exportBtn.addEventListener("click",()=>this.exportConversation()),this.elements.resetBtn&&this.elements.resetBtn.addEventListener("click",()=>this.resetConversation()),document.addEventListener("keydown",this.handleKeyDown),window.addEventListener("resize",this.handleResize);const e=document.querySelector(".ofac-skip-link");e&&e.addEventListener("click",e=>{e.preventDefault(),this.open(),this.focusInput()})}handleKeyDown(e){"Escape"===e.key&&this.isOpen&&this.close(),"Tab"===e.key&&this.isOpen&&this.handleTabKey(e)}handleTabKey(e){if(!this.elements.modal)return;const t=this.elements.modal.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'),s=t[0],n=t[t.length-1];e.shiftKey&&document.activeElement===s?(e.preventDefault(),n.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),s.focus())}handleOutsideClick(e){this.elements.modal&&!this.elements.modal.contains(e.target)&&this.elements.trigger&&!this.elements.trigger.contains(e.target)&&this.close()}handleResize(){this.isOpen&&this.adjustModalPosition()}adjustModalPosition(){if(!this.elements.modal)return;const e=window.innerWidth<768;this.elements.modal.classList.toggle("ofac-modal--mobile",e)}checkReducedMotion(){const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=()=>{this.elements.container&&this.elements.container.classList.toggle("ofac-reduced-motion",e.matches)};t(),e.addEventListener("change",t)}open(){this.isOpen||(!this.config.settings.require_consent||this.hasConsent?(this.isOpen=!0,this.lastFocusedElement=document.activeElement,this.elements.modal&&(this.elements.modal.classList.add("ofac-modal--open"),this.elements.modal.setAttribute("aria-hidden","false")),this.elements.trigger&&this.elements.trigger.setAttribute("aria-expanded","true"),this.adjustModalPosition(),setTimeout(()=>this.focusInput(),100),document.addEventListener("click",this.handleOutsideClick),this.announce(this.config.labels.chat_opened||"Chat ouvert"),this.trigger("ofac:open")):this.showConsentDialog())}close(){this.isOpen&&(this.isOpen=!1,this.elements.modal&&(this.elements.modal.classList.remove("ofac-modal--open"),this.elements.modal.setAttribute("aria-hidden","true")),this.elements.trigger&&this.elements.trigger.setAttribute("aria-expanded","false"),this.lastFocusedElement&&this.lastFocusedElement.focus(),document.removeEventListener("click",this.handleOutsideClick),this.abortController&&this.abortController.abort(),this.trigger("ofac:close"))}focusInput(){this.elements.inputField&&this.elements.inputField.focus()}showConsentDialog(){this.elements.consentDialog&&(this.elements.consentDialog.classList.add("ofac-consent--visible"),this.elements.consentDialog.setAttribute("aria-hidden","false"),this.elements.consentAccept&&this.elements.consentAccept.focus())}hideConsentDialog(){this.elements.consentDialog&&(this.elements.consentDialog.classList.remove("ofac-consent--visible"),this.elements.consentDialog.setAttribute("aria-hidden","true"))}acceptConsent(){this.hasConsent=!0,this.hideConsentDialog(),this.recordConsent(!0),this.open()}declineConsent(){this.hasConsent=!1,this.hideConsentDialog(),this.recordConsent(!1)}recordConsent(e){const t=new FormData;t.append("action","ofac_set_consent"),t.append("nonce",this.config.nonce),t.append("consent",e?"1":"0"),t.append("session_id",this.sessionId),fetch(this.config.ajax_url,{method:"POST",body:t,credentials:"same-origin"}).catch(e=>{console.error("OFAC: Error recording consent",e)})}checkConsent(){const e=this.getCookie("ofac_consent");this.hasConsent="1"===e}async sendMessage(e=null){const t=e||(this.elements.inputField?this.elements.inputField.value.trim():"");if(!t&&!this.pendingImage||this.isProcessing)return;if(t&&this.isCommand(t))return this.processCommand(t),void this.clearInput();const s=this.config.settings.max_message_length||2e3;if(t&&t.length>s)return void this.showError(this.config.labels.message_too_long||`Message trop long (max ${s} caract√®res)`);t&&this.addToHistory(t),this.isProcessing=!0,this.disableSendButton(),this.clearInput();const n=this.pendingImage;if(n){const e=`<div class="ofac-message-image"><img src="${n.preview}" alt="${n.name}" /></div>`;this.addMessage("user",t?`${e}<p>${t}</p>`:e,{isHtml:!0}),this.removeImagePreview()}else this.addMessage("user",t);this.showTyping();try{this.config.stream_enabled?await this.sendStreamingMessage(t,n):await this.sendStandardMessage(t,n)}catch(e){this.hideTyping(),"AbortError"!==e.name&&this.showError(e.message||this.config.labels.error_message)}finally{this.isProcessing=!1,this.enableSendButton()}}disableSendButton(){this.elements.sendBtn&&(this.elements.sendBtn.disabled=!0,this.elements.sendBtn.classList.add("ofac-loading")),this.elements.inputField&&(this.elements.inputField.disabled=!0)}enableSendButton(){this.elements.sendBtn&&(this.elements.sendBtn.disabled=!1,this.elements.sendBtn.classList.remove("ofac-loading")),this.elements.inputField&&(this.elements.inputField.disabled=!1,this.elements.inputField.focus())}addToHistory(e){if(e&&""!==e.trim()&&this.commandHistory[0]!==e){this.commandHistory.unshift(e),this.commandHistory.length>50&&this.commandHistory.pop();try{localStorage.setItem("ofac_command_history",JSON.stringify(this.commandHistory))}catch(e){}this.commandHistoryIndex=-1}}loadCommandHistory(){try{const e=localStorage.getItem("ofac_command_history");e&&(this.commandHistory=JSON.parse(e))}catch(e){this.commandHistory=[]}}navigateHistory(e){this.elements.inputField&&0!==this.commandHistory.length&&(-1===this.commandHistoryIndex&&"up"===e&&(this.currentInput=this.elements.inputField.value),"up"===e?this.commandHistoryIndex<this.commandHistory.length-1&&(this.commandHistoryIndex++,this.elements.inputField.value=this.commandHistory[this.commandHistoryIndex]):this.commandHistoryIndex>0?(this.commandHistoryIndex--,this.elements.inputField.value=this.commandHistory[this.commandHistoryIndex]):0===this.commandHistoryIndex&&(this.commandHistoryIndex=-1,this.elements.inputField.value=this.currentInput),this.elements.inputField.setSelectionRange(this.elements.inputField.value.length,this.elements.inputField.value.length),this.updateSendButton())}async sendStandardMessage(e,t=null){const s=new FormData;s.append("action","ofac_chat"),s.append("nonce",this.config.nonce),s.append("message",e||""),s.append("session_id",this.sessionId),t&&t.base64&&(s.append("image_data",t.base64),s.append("image_name",t.name),s.append("image_mime",t.mime)),s.append("ofac_hp",""),this.abortController=new AbortController;const n=await fetch(this.config.ajax_url,{method:"POST",body:s,credentials:"same-origin",signal:this.abortController.signal}),i=await n.json();if(this.hideTyping(),!i.success)throw new Error(i.data?.message||this.config.labels.error_message);{const e=i.data.text||i.data.response||"";this.addMessage("assistant",e,{sources:i.data.sources,suggestions:i.data.suggestions}),i.data.suggestions&&i.data.suggestions.length&&this.showQuickReplies(i.data.suggestions)}}async sendStreamingMessage(e,t=null){if(t)return this.sendStandardMessage(e,t);const s=new URLSearchParams({action:"ofac_chat_stream",nonce:this.config.nonce,message:e,session_id:this.sessionId});this.abortController=new AbortController;const n=await fetch(`${this.config.ajax_url}?${s}`,{method:"GET",credentials:"same-origin",signal:this.abortController.signal});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);this.hideTyping();const i=this.addMessage("assistant","",{streaming:!0}),o=document.getElementById(i),a=o?.querySelector(".ofac-message-bubble");if(!a)return;const r=n.body.getReader(),c=new TextDecoder;let l="",d="";try{for(;;){const{done:e,value:t}=await r.read();if(e)break;d+=c.decode(t,{stream:!0});const s=d.split("\n");d=s.pop()||"";for(const e of s)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t){this.updateMessageContent(a,l,!1),this.saveHistory();break}try{const e=JSON.parse(t);e.textResponse&&(l+=e.textResponse,this.updateMessageContent(a,l,!0)),e.sources&&this.addSourcesToMessage(o,e.sources),e.suggestedQuestions&&this.showQuickReplies(e.suggestedQuestions)}catch(e){}}}}finally{r.releaseLock()}const h=this.conversationHistory.findIndex(e=>e.id===i);-1!==h&&(this.conversationHistory[h].content=l)}updateMessageContent(e,t,s=!1){if(!e)return;const n=this.parseMarkdown(t);e.innerHTML=n,s||this.highlightCode(e),this.scrollToBottom()}parseMarkdown(e){if(!e)return"";let t=this.escapeHtml(e);return t=t.replace(/```(\w*)\n([\s\S]*?)```/g,(e,t,s)=>{const n=t||"plaintext";return`<pre class="ofac-code-block" data-language="${n}"><code class="language-${n}">${s.trim()}</code></pre>`}),t=t.replace(/`([^`]+)`/g,'<code class="ofac-inline-code">$1</code>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),t=t.replace(/\n/g,"<br>"),t}highlightCode(e){e.querySelectorAll("pre code").forEach(e=>{"undefined"!=typeof Prism&&Prism.highlightElement(e)})}addMessage(e,t,s={}){const n=`ofac-msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i={id:n,role:e,content:t,timestamp:(new Date).toISOString(),...s};this.conversationHistory.push(i);const o=this.createMessageElement(i);return this.elements.messagesContainer&&this.elements.messagesContainer.appendChild(o),s.streaming||this.saveHistory(),this.scrollToBottom(),"assistant"===e&&this.announce(this.config.labels.new_message||"Nouveau message"),n}createMessageElement(e){const t=document.createElement("div");t.id=e.id,t.className=`ofac-message ofac-message--${e.role}`,t.setAttribute("role","article");const s="user"===e.role?this.config.settings.user_avatar:this.config.settings.bot_avatar,n='<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">\n                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>\n            </svg>',i=s?`<img src="${s}" alt="" class="ofac-message-avatar" aria-hidden="true" \n                        onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">\n                   <div class="ofac-message-avatar ofac-avatar-default" aria-hidden="true" style="display:none;">${n}</div>`:`<div class="ofac-message-avatar ofac-avatar-default" aria-hidden="true">${n}</div>`,o=e.isHtml?e.content:this.parseMarkdown(e.content),a=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return t.innerHTML=`\n                ${i}\n                <div class="ofac-message-content">\n                    <div class="ofac-message-bubble">${o}</div>\n                    <div class="ofac-message__meta">\n                        <time class="ofac-message__time" datetime="${e.timestamp}">${a}</time>\n                        ${"assistant"===e.role?this.createMessageActions(e.id):""}\n                    </div>\n                    ${e.sources?this.createSourcesHtml(e.sources):""}\n                </div>\n            `,"assistant"===e.role&&this.bindMessageActions(t,e),t}createMessageActions(e){return`\n                <div class="ofac-message__actions">\n                    <button type="button" class="ofac-message__action ofac-message__action--copy" \n                            data-action="copy" data-message-id="${e}"\n                            aria-label="${this.config.labels.copy||"Copier"}">\n                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>\n                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>\n                        </svg>\n                    </button>\n                    <button type="button" class="ofac-message__action ofac-message__action--thumbup" \n                            data-action="thumbup" data-message-id="${e}"\n                            aria-label="${this.config.labels.helpful||"Utile"}">\n                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>\n                        </svg>\n                    </button>\n                    <button type="button" class="ofac-message__action ofac-message__action--thumbdown" \n                            data-action="thumbdown" data-message-id="${e}"\n                            aria-label="${this.config.labels.not_helpful||"Pas utile"}">\n                        <svg aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>\n                        </svg>\n                    </button>\n                </div>\n            `}bindMessageActions(e,t){const s=e.querySelector('[data-action="copy"]'),n=e.querySelector('[data-action="thumbup"]'),i=e.querySelector('[data-action="thumbdown"]');s&&s.addEventListener("click",()=>this.copyMessage(t)),n&&n.addEventListener("click",e=>this.rateMessage(t.id,1,e.currentTarget)),i&&i.addEventListener("click",e=>this.rateMessage(t.id,-1,e.currentTarget))}async copyMessage(e){try{await navigator.clipboard.writeText(e.content),this.showToast(this.config.labels.copied||"Copi√© !")}catch(e){console.error("OFAC: Copy failed",e)}}async rateMessage(e,t,s){const n=new FormData;n.append("action","ofac_feedback"),n.append("nonce",this.config.nonce),n.append("message_id",e),n.append("rating",t);try{const e=await fetch(this.config.ajax_url,{method:"POST",body:n,credentials:"same-origin"});if((await e.json()).success){const e=s.closest(".ofac-message__actions");e&&(e.querySelectorAll(".ofac-message__action").forEach(e=>{e.classList.remove("ofac-message__action--active")}),s.classList.add("ofac-message__action--active"))}}catch(e){console.error("OFAC: Feedback error",e)}}createSourcesHtml(e){if(!e||!e.length)return"";return`<div class="ofac-message__sources">${e.map((e,t)=>{const s=e.title||`Source ${t+1}`;return`<a href="${e.url||"#"}" target="_blank" rel="noopener noreferrer" class="ofac-source">${this.escapeHtml(s)}</a>`}).join("")}</div>`}addSourcesToMessage(e,t){if(!e||!t||!t.length)return;const s=e.querySelector(".ofac-message__sources");s&&s.remove();const n=e.querySelector(".ofac-message__body");n&&n.insertAdjacentHTML("beforeend",this.createSourcesHtml(t))}showQuickReplies(e){if(!this.elements.quickReplies||!e||!e.length)return;const t=e.map(e=>`<button type="button" class="ofac-quick-reply">${this.escapeHtml(e)}</button>`).join("");this.elements.quickReplies.innerHTML=t,this.elements.quickReplies.classList.add("ofac-quick-replies--visible"),this.elements.quickReplies.querySelectorAll(".ofac-quick-reply").forEach(e=>{e.addEventListener("click",()=>{this.sendMessage(e.textContent),this.hideQuickReplies()})})}hideQuickReplies(){this.elements.quickReplies&&(this.elements.quickReplies.classList.remove("ofac-quick-replies--visible"),this.elements.quickReplies.innerHTML="")}showTyping(){this.isTyping=!0,this.elements.typingIndicator&&(this.elements.typingIndicator.classList.add("ofac-typing--visible"),this.elements.typingIndicator.setAttribute("aria-hidden","false")),this.scrollToBottom()}hideTyping(){this.isTyping=!1,this.elements.typingIndicator&&(this.elements.typingIndicator.classList.remove("ofac-typing--visible"),this.elements.typingIndicator.setAttribute("aria-hidden","true"))}scrollToBottom(){this.elements.messagesContainer&&(this.elements.messagesContainer.scrollTop=this.elements.messagesContainer.scrollHeight)}clearInput(){this.elements.inputField&&(this.elements.inputField.value="",this.autoResizeInput(),this.updateSendButton())}autoResizeInput(){this.elements.inputField&&(this.elements.inputField.style.height="auto",this.elements.inputField.style.height=Math.min(this.elements.inputField.scrollHeight,150)+"px")}updateSendButton(){if(!this.elements.sendBtn||!this.elements.inputField)return;const e=this.elements.inputField.value.trim().length>0;this.elements.sendBtn.disabled=!e||this.isProcessing}isCommand(e){return e.startsWith("/")}processCommand(e){const t=e.toLowerCase().split(" ")[0];e.slice(t.length).trim();switch(t){case"/reset":this.resetConversation();break;case"/help":this.showHelp();break;case"/export":this.exportConversation();break;default:this.addMessage("system",this.config.labels.unknown_command||`Commande inconnue: ${t}`)}}showHelp(){this.addMessage("system","**Commandes disponibles:**\n- `/reset` - Effacer la conversation\n- `/help` - Afficher cette aide\n- `/export` - Exporter la conversation")}resetConversation(){confirm(this.config.labels.confirm_reset||"Voulez-vous vraiment effacer la conversation ?")&&(this.conversationHistory=[],this.saveHistory(),this.elements.messagesContainer&&(this.elements.messagesContainer.innerHTML=""),this.hideQuickReplies(),this.sessionId=this.generateSessionId(),sessionStorage.setItem("ofac_session_id",this.sessionId),this.addMessage("system",this.config.labels.conversation_reset||"Conversation effac√©e."),this.trigger("ofac:reset"))}exportConversation(){if(!this.conversationHistory.length)return void this.showToast(this.config.labels.nothing_to_export||"Rien √† exporter");let e=`Conversation - ${(new Date).toLocaleDateString()}\n${"=".repeat(40)}\n\n`;this.conversationHistory.forEach(t=>{const s=new Date(t.timestamp).toLocaleTimeString(),n="user"===t.role?"Vous":"Assistant";e+=`[${s}] ${n}:\n${t.content}\n\n`});const t=new Blob([e],{type:"text/plain;charset=utf-8"}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=`conversation-${Date.now()}.txt`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),this.showToast(this.config.labels.exported||"Conversation export√©e"),this.trigger("ofac:export")}async handleFileUpload(e){if(!e||!e.length)return;const t=1024*(this.config.settings.max_file_size||5)*1024,s=this.config.settings.allowed_file_types||["pdf","txt","doc","docx","jpg","jpeg","png","gif","webp"],n=["jpg","jpeg","png","gif","webp"];for(const i of e){if(i.size>t){this.showError(`${i.name}: ${this.config.labels.file_too_large||"Fichier trop volumineux"}`);continue}const e=i.name.split(".").pop().toLowerCase();s.includes(e)?n.includes(e)?await this.prepareImageForChat(i):await this.uploadFile(i):this.showError(`${i.name}: ${this.config.labels.file_type_not_allowed||"Type de fichier non autoris√©"}`)}this.elements.fileInput&&(this.elements.fileInput.value="")}async prepareImageForChat(e){try{const t=await this.fileToBase64(e);this.pendingImage={name:e.name,mime:e.type,base64:t,preview:URL.createObjectURL(e)},this.showImagePreview(),this.focusInput()}catch(e){this.showError(e.message||"Erreur lors du chargement de l'image")}}fileToBase64(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=()=>s(new Error("Erreur de lecture du fichier")),n.readAsDataURL(e)})}showImagePreview(){if(!this.pendingImage)return;let e=document.getElementById("ofac-image-preview");if(!e){e=document.createElement("div"),e.id="ofac-image-preview",e.className="ofac-image-preview";const t=this.elements.inputForm;t&&t.parentNode&&t.parentNode.insertBefore(e,t)}e.innerHTML=`\n                <div class="ofac-image-preview-content">\n                    <img src="${this.pendingImage.preview}" alt="Preview" />\n                    <span class="ofac-image-preview-name">${this.pendingImage.name}</span>\n                    <button type="button" class="ofac-image-preview-remove" aria-label="Supprimer l'image">√ó</button>\n                </div>\n                <span class="ofac-image-preview-hint">Posez votre question sur cette image</span>\n            `;const t=e.querySelector(".ofac-image-preview-remove");t&&t.addEventListener("click",()=>this.removeImagePreview()),e.style.display="flex"}removeImagePreview(){this.pendingImage&&this.pendingImage.preview&&URL.revokeObjectURL(this.pendingImage.preview),this.pendingImage=null;const e=document.getElementById("ofac-image-preview");e&&(e.style.display="none",e.innerHTML="")}async uploadFile(e){this.showTyping();const t=new FormData;t.append("action","ofac_upload_file"),t.append("nonce",this.config.nonce),t.append("file",e),t.append("session_id",this.sessionId);try{const s=await fetch(this.config.ajax_url,{method:"POST",body:t,credentials:"same-origin"}),n=await s.json();if(this.hideTyping(),!n.success)throw new Error(n.data?.message||this.config.labels.upload_error);this.addMessage("user",`üìé ${e.name}`),this.showToast(n.data.message||this.config.labels.file_uploaded||"Fichier upload√©")}catch(e){this.hideTyping(),this.showError(e.message)}}saveHistory(){try{const e={sessionId:this.sessionId,messages:this.conversationHistory,timestamp:Date.now()};localStorage.setItem("ofac_history",JSON.stringify(e))}catch(e){console.error("OFAC: Failed to save history",e)}}loadHistory(){try{const e=localStorage.getItem("ofac_history");if(!e)return;const t=JSON.parse(e),s=864e5;if(Date.now()-t.timestamp>s)return void localStorage.removeItem("ofac_history");t.sessionId&&(this.sessionId=t.sessionId),t.messages&&t.messages.length&&(t.messages.forEach(e=>{this.conversationHistory.push(e);const t=this.createMessageElement(e);this.elements.messagesContainer&&this.elements.messagesContainer.appendChild(t)}),this.scrollToBottom())}catch(e){console.error("OFAC: Failed to load history",e)}}getOrCreateSessionId(){let e=sessionStorage.getItem("ofac_session_id");return e||(e=this.generateSessionId(),sessionStorage.setItem("ofac_session_id",e)),e}generateSessionId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}showError(e){this.addMessage("system",`‚ö†Ô∏è ${e}`)}showToast(e){const t=document.createElement("div");t.className="ofac-toast",t.textContent=e,t.setAttribute("role","status"),t.setAttribute("aria-live","polite"),document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("ofac-toast--visible")}),setTimeout(()=>{t.classList.remove("ofac-toast--visible"),setTimeout(()=>t.remove(),300)},3e3)}announce(e){const t=document.getElementById("ofac-announcer");t&&(t.textContent=e)}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}debounce(e,t){let s;return function(...n){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),e(...n)},t)}}trigger(e,t={}){const s=new CustomEvent(e,{detail:t});document.dispatchEvent(s)}}}else console.error("OFAC: Configuration not found")}();